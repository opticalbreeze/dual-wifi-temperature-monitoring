_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
_/
_/  DHCPサーバーとNATを構築する手順
_/
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/


-------------------------------------------------
▼ パッケージのインストール
-------------------------------------------------
sudo apt-get install isc-dhcp-server
sudo apt install iptables-persistent
sudo apt install ufw


-------------------------------------------------
▼ 有線LANとWi-Fiデバイスの
   デバイス名とMACアドレスを取得する
   [ 有線LAN ] 
   [ Wi-Fi   ] 

   ※以降、各デバイス名は
     有線LANは"enx1ds"、Wi-Fiは"wlx0us"とします
-------------------------------------------------
ip a


-------------------------------------------------
▼ ネットワーク設定ファイルを作成
-------------------------------------------------
sudo nano /etc/netplan/99-guest2nat.yaml


+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| 99-guest2nat.yaml
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

#デバイス名とMACアドレスを実機のものに書き換えること
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    enxc8a362bedfae:
      match:
         macaddress: c8:a3:62:be:df:ae
      set-name: enx1ds
      networkmanager:
        name: "有線接続@enx1ds"
      dhcp4: false
      dhcp6: false
      addresses: [192.168.206.100/24]
      routes:
       - to: default
         via: 192.168.206.100
         metric: 700
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
  wifis:
    wlxa047d7206960:
      match:
         macaddress: a0:47:d7:20:69:60
      set-name: wlx0us
      networkmanager:
        name: "INT_guest2@wlx0us"
      dhcp4: true
      dhcp6: false
      access-points:
        INT_guest2:
          auth:
            key-management: none


-------------------------------------------------
▼ ネットワーク設定ファイルを適用
-------------------------------------------------
sudo chmod 600 /etc/netplan/99-guest2nat.yaml
sudo netplan apply


-------------------------------------------------
▼ DHCPサーバー設定(1/2)
-------------------------------------------------
sudo nano /etc/default/isc-dhcp-server


+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  isc-dhcp-server
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

# 4行目 : コメント解除
DHCPDv4_CONF=/etc/dhcp/dhcpd.conf

# 17行目 : リスンするインターフェースを指定
INTERFACESv4="enx1ds"


-------------------------------------------------
▼ DHCPサーバー設定(2/2)
-------------------------------------------------
sudo nano /etc/dhcp/dhcpd.conf


+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  dhcpd.conf
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

# 最終行に以下追記
# ネットワークアドレスとサブネットマスク指定
subnet 192.168.206.0 netmask 255.255.255.0 {
    # デフォルトゲートウェイ指定
    option routers 192.168.206.100;
    # サブネットマスク指定
    option subnet-mask 255.255.255.0;
    # DNSサーバー設定
    option domain-name-servers 8.8.8.8, 8.8.4.4;
    # 貸し出す IP アドレスの範囲指定
    range dynamic-bootp 192.168.206.101 192.168.206.200;
}


-------------------------------------------------
▼ DHCPサーバーを再起動
-------------------------------------------------
systemctl restart isc-dhcp-server


-------------------------------------------------
▼ IPフォワーディングを許可(1/2)
-------------------------------------------------
sudo nano /etc/default/ufw


+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  ufw
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

# 19行目 : 変更
DEFAULT_FORWARD_POLICY="ACCEPT"


-------------------------------------------------
▼ IPフォワーディングを許可(2/2)
-------------------------------------------------
sudo nano /etc/sysctl.conf


+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  sysctl.conf
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

# 28行目 : コメント解除
net.ipv4.ip_forward=1


-------------------------------------------------
▼ ファイアウォール設定
   (NATの内側でのSSH, HTTPを許可)
-------------------------------------------------
sudo sysctl -p
sudo ufw allow ssh
sudo ufw allow http
sudo ufw enable
sudo ufw default deny
sudo ufw reload


-------------------------------------------------
▼ NAT設定
-------------------------------------------------
sudo iptables -t nat -A POSTROUTING -s 192.168.206.0/24 -o wlx0us -j MASQUERADE
sudo netfilter-persistent save
sudo netfilter-persistent reload


以上