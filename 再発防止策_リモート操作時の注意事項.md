# 再発防止策 - リモート操作時の注意事項

**作成日**: 2025年12月29日  
**問題**: リモート接続中のラズパイのネットワーク設定（wlan1）を変更し、接続を切断してしまった

---

## 🔴 発生した問題

### 問題の概要
- リモート接続中（SSH経由）にwlan1のネットワーク設定を変更しようとした
- wlan1が別のWiFiに接続していた状態で、APモードに切り替えようとした
- 結果として接続が切断され、Tailscaleも停止

### 何が間違っていたか

1. **リモート操作時の危険性を考慮していなかった**
   - ネットワーク設定を変更するスクリプトを、リモート接続中のシステムで実行しようとした
   - wlan1だけでなく、全体的なネットワークサービスに影響を与える可能性を検討していなかった

2. **現状確認を十分に行わなかった**
   - wlan1が実際にどの状態にあるか（APモードか、Stationモードか）を十分に確認せずにスクリプトを作成した
   - wlan1が別のWiFiに接続している状態を認識していたにもかかわらず、接続を切断する手順を含めてしまった

3. **接続経路の保護を考慮していなかった**
   - wlan0（インターネット接続用）が唯一の接続経路であることを認識していたが、wlan1の設定変更がwlan0に影響しないことを確実に検証していなかった
   - Tailscaleなどの他の接続手段への影響を考慮していなかった

4. **`killall wpa_supplicant` の危険性を認識していなかった**
   - wpa_supplicantを停止すると、wlan0の接続も切れる可能性がある
   - wlan1専用のwpa_supplicantプロセスを特定せずに、全体を停止しようとした

---

## ✅ 再発防止策

### 1. **リモート操作時の基本原則**

#### ❌ やってはいけないこと
- **ネットワーク設定を変更するスクリプトをリモート実行しない**
- **接続を切断する可能性のあるコマンドを実行しない**
  - `systemctl stop wpa_supplicant` （全体に影響）
  - `killall wpa_supplicant` （全体に影響）
  - `pkill wpa_supplicant` （全体に影響）
  - `nmcli device set` （wlan0を含む場合）
  - `ip link set down` （接続中のインターフェース）
- **サービスを停止・再起動する前に接続経路を確認しない**

#### ✅ やるべきこと
- **現状確認を必ず行う**
  ```bash
  # 接続経路の確認
  ip route show
  ip route show default
  ip addr show
  systemctl status wpa_supplicant
  systemctl status NetworkManager
  
  # どのインターフェースが接続に使われているか確認
  netstat -rn | grep default
  ```
- **影響範囲を事前に分析する**
  - コマンドを実行する前に、どのインターフェースに影響があるか確認
  - 接続経路（wlan0）に影響がないことを確認
  - wpa_supplicantのようなサービスが複数のインターフェースに影響することを認識
- **段階的に実行する**
  - 一度にすべてを変更せず、一つずつ確認しながら実行
  - 問題が発生した場合にロールバックできるようにする

### 2. **ネットワーク設定変更時のチェックリスト**

#### 実行前の確認事項
- [ ] 現在の接続経路を確認したか？
  ```bash
  ip route show default
  ```
- [ ] 変更対象のインターフェースが接続に使用されていないか確認したか？
  ```bash
  ip addr show <interface>
  ip route show | grep <interface>
  ```
- [ ] 他の接続手段（Tailscale、Ethernet等）が利用可能か確認したか？
- [ ] 変更内容が接続中のインターフェース（wlan0）に影響しないか確認したか？
- [ ] 現地での復旧手順を準備したか？
- [ ] **リモート実行か現地操作かを明確にしたか？**

#### 実行時の注意事項
- [ ] 一度に一つずつコマンドを実行し、各ステップで結果を確認
- [ ] 接続が切れないか常に監視
- [ ] 問題が発生した場合のロールバック手順を準備
- [ ] **wpa_supplicantなどのサービスは複数のインターフェースに影響することを認識**

### 3. **wlan1 AP設定時の正しい手順**

#### リモート操作時は実行しない
- wlan1の設定変更は**現地操作のみ**で行う
- または、**別の接続経路（Ethernet、Tailscale等）が確実にある場合のみ**

#### 現地操作時の手順
```bash
# 1. 現在の状態を確認
ip route show default  # デフォルトゲートウェイを確認
ip addr show wlan0     # インターネット接続確認
ip addr show wlan1     # AP状態確認

# 2. NetworkManagerがwlan1を管理しないように設定（wlan0には影響なし）
sudo nmcli device set wlan1 managed no

# 3. wlan1の既存IPを削除（wlan1のみ）
sudo ip addr flush dev wlan1

# 4. wlan1に静的IPを設定
sudo ip addr add 192.168.4.1/24 dev wlan1

# 5. wlan1を有効化
sudo ip link set wlan1 up

# 6. サービスを再起動
sudo systemctl restart hostapd
sudo systemctl restart dnsmasq

# 7. 確認（wlan0の接続が維持されていることを確認）
ip addr show wlan0
ping -c 2 8.8.8.8
```

### 4. **スクリプト作成時のガイドライン**

#### スクリプトに含めるべき要素
- **接続状態の確認コマンド**
- **影響範囲の説明コメント**
- **実行前の警告メッセージ**
- **ロールバック手順**
- **リモート実行の検出と防止**

#### スクリプトの例（改善版）
```bash
#!/bin/bash
# wlan1 AP設定スクリプト（現地操作専用）

# リモート実行の検出
if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_CLIENT" ]; then
    echo "⚠️  警告: SSH接続中です。このスクリプトはリモート実行できません。"
    echo "現地（HDMI/キーボード）で実行してください。"
    exit 1
fi

set -e

echo "警告: このスクリプトはネットワーク設定を変更します。"
echo "リモート接続中の場合は実行しないでください。"
echo ""
read -p "続行しますか？ (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
fi

# 接続経路の確認
echo "=== 現在の接続状態を確認 ==="
DEFAULT_IF=$(ip route show default | awk '{print $5}' | head -1)
echo "デフォルトゲートウェイ: $DEFAULT_IF"

if [ "$DEFAULT_IF" = "wlan1" ]; then
    echo "❌ エラー: wlan1が接続に使用されています。実行を中止します。"
    exit 1
fi

echo "wlan0の状態:"
ip addr show wlan0 | grep "inet " || echo "警告: wlan0にIPアドレスがありません"

echo ""
echo "=== wlan1の設定を開始 ==="
# ... 以下、設定処理（wpa_supplicantには触れない）
```

### 5. **コードレビューチェックリスト**

スクリプトを作成・変更する際のチェック項目：

- [ ] ネットワーク設定を変更するコマンドが含まれているか？
- [ ] リモート実行される可能性があるか？
- [ ] 接続を切断する可能性があるコマンド（`killall`, `systemctl stop`）が含まれているか？
- [ ] 接続経路（wlan0）への影響を考慮しているか？
- [ ] 実行前の警告メッセージがあるか？
- [ ] 現状確認のコマンドが含まれているか？
- [ ] ロールバック手順が記載されているか？
- [ ] **リモート実行の検出機能があるか？**
- [ ] **wpa_supplicantなどのサービスが複数インターフェースに影響することを考慮しているか？**

---

## 📝 今回の問題から学んだこと

1. **リモート操作時の危険性**
   - ネットワーク設定は一度失敗すると、復旧が困難
   - 接続を切る可能性があるコマンドは、リモートでは絶対に実行しない
   - **`killall`や`systemctl stop`は全体に影響することを認識**

2. **現状確認の重要性**
   - 変更前に必ず現状を確認する
   - どのインターフェースが何に使われているかを明確にする
   - デフォルトゲートウェイを確認する

3. **段階的なアプローチ**
   - 一度にすべてを変更せず、確認しながら進める
   - 問題発生時の対処法を事前に準備する

4. **スクリプトの設計**
   - リモート実行を想定しないスクリプトには明確に明記する
   - 実行前の警告と確認を必須にする
   - **リモート実行の検出機能を組み込む**

5. **サービスの影響範囲**
   - wpa_supplicant、NetworkManagerなどのサービスは複数のインターフェースに影響する
   - 特定のインターフェースのみに影響を与えるコマンドを選択する

---

## 🎯 今後の対応方針

### スクリプト作成時の方針
1. **ネットワーク設定変更スクリプトは「現地操作専用」と明記**
2. **リモート実行される可能性がある場合は、読み取り専用コマンド（確認コマンド）のみ提供**
3. **変更が必要な場合は、手動実行手順を文書化**
4. **リモート実行の検出機能を組み込む（SSH_CONNECTIONのチェック）**

### コードレビューの強化
1. **ネットワーク関連の変更は必ずレビュー**
2. **リモート実行の可能性を考慮**
3. **接続経路への影響を確認**
4. **`killall`、`systemctl stop`などの危険なコマンドをチェック**

### ドキュメント化
1. **既存のスクリプトに「現地操作専用」などの注記を追加**
2. **リモート操作時の注意事項をREADMEに追加**
3. **トラブルシューティング手順を整備**

### スクリプトテンプレートの作成
1. **安全なスクリプトのテンプレートを作成**
2. **リモート実行検出、確認プロンプト、ロールバック手順を含める**
