# 環境変数設定ガイド

**作成日:** 2025年12月27日  
**対象:** 全環境（開発・本番）  
**目的:** 安全で効率的な環境変数管理

---

## `.env.template` 使用方法

### ステップ 1: テンプレートをコピー

```bash
cd f:\環境データ収集システム\raspberry_pi

# テンプレートをコピー
cp .env.template .env
```

### ステップ 2: 各項目を設定

エディタで `.env` ファイルを開き、各環境変数を設定してください。

### ステップ 3: 確認

```bash
# 設定が正しく読み込まれるか確認
python3 -c "from shared.config.base import Config; print('✓ Config loaded')"
```

---

## 環境変数一覧

### セキュリティ関連

#### `SECRET_KEY` ⭐ 必須

Flask セッション暗号化キー

```bash
# 生成方法（Windows PowerShell）
$bytes = @()
for ($i = 0; $i -lt 32; $i++) {
    $bytes += [byte](Get-Random -Minimum 0 -Maximum 256)
}
$hex = [System.BitConverter]::ToString($bytes) -replace '-', ''
Write-Host "SECRET_KEY=$hex"

# または（Linux/Mac）
openssl rand -hex 32
```

**設定例:**
```bash
SECRET_KEY=abc123def456...
```

**チェック:**
```bash
# 32文字以上か確認
python3 -c "import os; os.environ['SECRET_KEY'] = input(); assert len(os.environ['SECRET_KEY']) >= 32"
```

### WiFi 関連

#### `AP_SSID`

WiFi アクセスポイント SSID（ESP32接続用）

```bash
AP_SSID=RaspberryPi_Temperature
```

**制約:**
- 1〜32 文字
- 英数字、アンダースコア、ハイフンのみ
- 特殊文字は避ける

#### `AP_PASSWORD` ⭐ 必須

WiFi アクセスポイント パスワード

```bash
AP_PASSWORD=YourSecurePassword123!
```

**制約:**
- **8文字以上** ❗
- 英数字・記号を混在させることを推奨
- 推奨: 12文字以上

**安全なパスワード生成:**
```bash
# PowerShell
-join ((48..122) | Where-Object {$_ -notin (91..96)} | Get-Random -Count 16 | ForEach-Object {[char]$_})

# Linux/Mac
LC_ALL=C tr -dc 'A-Za-z0-9!@#$%' < /dev/urandom | head -c 16
```

### ロギング関連

#### `LOG_LEVEL`

ログレベル（詳細度）

```bash
# 開発環境
LOG_LEVEL=DEBUG

# 本番環境
LOG_LEVEL=WARNING
```

**オプション:**
- `DEBUG`: 最も詳細（開発用）
- `INFO`: 通常情報（デフォルト）
- `WARNING`: 警告のみ（本番用）
- `ERROR`: エラーのみ
- `CRITICAL`: 致命的エラーのみ

### Flask 関連

#### `FLASK_ENV`

Flask 実行環境

```bash
# 開発環境
FLASK_ENV=development

# 本番環境
FLASK_ENV=production
```

#### `FLASK_DEBUG`

Flask デバッグモード

```bash
# 開発環境：有効
FLASK_DEBUG=True

# 本番環境：無効
FLASK_DEBUG=False
```

### Tailscale 関連（オプション）

遠隔管理機能を使用する場合のみ設定

#### `TAILSCALE_ENABLED`

Tailscale 機能の有効化

```bash
# 有効化
TAILSCALE_ENABLED=True

# 無効化（デフォルト）
TAILSCALE_ENABLED=False
```

#### `TAILSCALE_AUTH_KEY`

Tailscale 認証キー（`TAILSCALE_ENABLED=True` の場合は必須）

```bash
TAILSCALE_AUTH_KEY=tskey-your-key-here
```

**取得方法:**
1. https://tailscale.com/admin/authkeys にアクセス
2. "Generate auth key" をクリック
3. 表示されたキーをコピーして設定

### 温度監視関連

#### `TEMPERATURE_MIN`

最低温度閾値（℃）

```bash
TEMPERATURE_MIN=5.0
```

#### `TEMPERATURE_MAX`

最高温度閾値（℃）

```bash
TEMPERATURE_MAX=40.0
```

#### `TEMPERATURE_ALERT_ENABLED`

温度アラート機能

```bash
# 有効
TEMPERATURE_ALERT_ENABLED=True

# 無効
TEMPERATURE_ALERT_ENABLED=False
```

### CORS 関連

#### `ALLOWED_ORIGINS`

API にアクセス可能なオリジン（カンマ区切り）

```bash
# 開発環境
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5000,http://192.168.4.1:5000

# 本番環境（IP固定）
ALLOWED_ORIGINS=http://192.168.4.1:5000,http://raspberry-pi.local:5000
```

**注意:**
- `http://` のプロトコル指定が必須
- ポート番号も指定（`:5000` など）
- 本番環境では最小限のオリジンに限定

---

## 環境別設定例

### 🔧 開発環境用

**ファイル:** `.env`

```bash
# ===== セキュリティ =====
SECRET_KEY=dev-key-12345678901234567890123456

# ===== WiFi =====
AP_SSID=RaspberryPi_Dev
AP_PASSWORD=dev-password-123

# ===== ロギング =====
LOG_LEVEL=DEBUG
FLASK_ENV=development
FLASK_DEBUG=True

# ===== 温度監視 =====
TEMPERATURE_MIN=5.0
TEMPERATURE_MAX=40.0
TEMPERATURE_ALERT_ENABLED=True

# ===== CORS =====
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5000,http://192.168.4.1:5000

# ===== Tailscale =====
TAILSCALE_ENABLED=False
```

### 🚀 本番環境用

**ファイル:** `.env` (本番用)

```bash
# ===== セキュリティ =====
SECRET_KEY=prod-secure-random-key-generated-by-openssl

# ===== WiFi =====
AP_SSID=RaspberryPi_Temperature
AP_PASSWORD=production-secure-password-here

# ===== ロギング =====
LOG_LEVEL=WARNING
FLASK_ENV=production
FLASK_DEBUG=False

# ===== 温度監視 =====
TEMPERATURE_MIN=5.0
TEMPERATURE_MAX=40.0
TEMPERATURE_ALERT_ENABLED=True

# ===== CORS =====
ALLOWED_ORIGINS=http://192.168.4.1:5000

# ===== Tailscale =====
TAILSCALE_ENABLED=True
TAILSCALE_AUTH_KEY=tskey-prod-key-from-admin-panel
```

---

## セキュリティベストプラクティス

### ✅ すべき事

- [x] `.env` ファイルを `.gitignore` に追加
- [x] SECRET_KEY は強力なランダム値を使用
- [x] AP_PASSWORD は 12 文字以上、複雑さ高し
- [x] 本番環境の認証情報は **秘密管理ツール** 使用（AWS Secrets Manager など）
- [x] ログレベルを本番環境では WARNING 以上に設定
- [x] CORS オリジンを限定（ワイルドカード禁止）

### ❌ してはいけない事

- ❌ `.env` をリポジトリにコミット
- ❌ ハードコードされた認証情報（パスワード、キー）
- ❌ ログに機密情報を出力
- ❌ CORS を無制限に許可（`*` 指定）
- ❌ 開発用認証情報を本番環境で使用
- ❌ デフォルト値に依存（明示的に設定）

---

## トラブルシューティング

### Q: `SECRET_KEY must be set in .env` エラー

**解決:**
```bash
# SECRET_KEY が設定されているか確認
grep "^SECRET_KEY=" .env

# 設定されていない場合、新しいキーを生成
openssl rand -hex 32
# 出力をコピーして .env に追記
# SECRET_KEY=abc123...
```

### Q: `AP_PASSWORD must be at least 8 characters` エラー

**解決:**
```bash
# AP_PASSWORD が 8 文字未満
# .env を編集して、より長いパスワードに変更
AP_PASSWORD=YourSecurePasswordWith12CharactersOrMore
```

### Q: CORS エラーで API が呼ばれない

**解決:**
```bash
# ALLOWED_ORIGINS を確認
grep "^ALLOWED_ORIGINS=" .env

# 例えば、http://example.com からアクセスしている場合
# ALLOWED_ORIGINS=http://example.com:5000 に追加
```

### Q: Tailscale 認証に失敗

**解決:**
```bash
# 認証キーの形式を確認
grep "^TAILSCALE_AUTH_KEY=" .env

# 正しい形式: tskey-で始まるキー
# 誤った形式: tskey-がない、または古いキー
```

---

## 環境変数の検証スクリプト

**ファイル:** `validate_env.py`

```python
#!/usr/bin/env python3
"""
環境変数を検証するスクリプト
"""

import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# .env を読み込み
load_dotenv()

def validate():
    """環境変数を検証"""
    
    errors = []
    
    # SECRET_KEY チェック
    secret_key = os.getenv('SECRET_KEY')
    if not secret_key or secret_key == 'dev-secret-key-change-in-production':
        errors.append("❌ SECRET_KEY: 未設定またはデフォルト値")
    elif len(secret_key) < 32:
        errors.append(f"❌ SECRET_KEY: 短すぎます（{len(secret_key)}/32以上）")
    else:
        print("✓ SECRET_KEY: OK")
    
    # AP_PASSWORD チェック
    ap_password = os.getenv('AP_PASSWORD')
    if not ap_password:
        errors.append("❌ AP_PASSWORD: 未設定")
    elif len(ap_password) < 8:
        errors.append(f"❌ AP_PASSWORD: 短すぎます（{len(ap_password)}/8以上）")
    else:
        print("✓ AP_PASSWORD: OK")
    
    # FLASK_ENV チェック
    flask_env = os.getenv('FLASK_ENV', 'production')
    if flask_env not in ['development', 'production']:
        errors.append(f"❌ FLASK_ENV: 無効な値（{flask_env}）")
    else:
        print(f"✓ FLASK_ENV: {flask_env}")
    
    # FLASK_DEBUG チェック
    flask_debug = os.getenv('FLASK_DEBUG', 'False').lower()
    if flask_debug == 'true' and flask_env == 'production':
        errors.append("⚠️  FLASK_DEBUG: 本番環境で True になっています")
    else:
        print(f"✓ FLASK_DEBUG: {flask_debug}")
    
    # LOG_LEVEL チェック
    log_level = os.getenv('LOG_LEVEL', 'INFO')
    valid_levels = ['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL']
    if log_level not in valid_levels:
        errors.append(f"❌ LOG_LEVEL: 無効な値（{log_level}）")
    else:
        print(f"✓ LOG_LEVEL: {log_level}")
    
    # CORS チェック
    allowed_origins = os.getenv('ALLOWED_ORIGINS')
    if not allowed_origins:
        errors.append("❌ ALLOWED_ORIGINS: 未設定")
    elif '*' in allowed_origins:
        errors.append("❌ ALLOWED_ORIGINS: ワイルドカード（*）は本番環境で禁止")
    else:
        print(f"✓ ALLOWED_ORIGINS: {len(allowed_origins.split(','))} origins configured")
    
    # Tailscale チェック
    tailscale_enabled = os.getenv('TAILSCALE_ENABLED', 'False').lower() == 'true'
    if tailscale_enabled:
        tailscale_key = os.getenv('TAILSCALE_AUTH_KEY')
        if not tailscale_key:
            errors.append("❌ TAILSCALE_AUTH_KEY: TAILSCALE_ENABLED=True なのに未設定")
        elif not tailscale_key.startswith('tskey-'):
            errors.append("❌ TAILSCALE_AUTH_KEY: 形式が不正（tskey-で始まるべき）")
        else:
            print("✓ TAILSCALE_AUTH_KEY: OK")
    
    # 結果出力
    print("\n" + "="*50)
    
    if errors:
        print("❌ エラーが見つかりました:\n")
        for error in errors:
            print(f"  {error}")
        return False
    else:
        print("✅ 全ての環境変数が正しく設定されています")
        return True

if __name__ == '__main__':
    success = validate()
    sys.exit(0 if success else 1)
```

**実行:**
```bash
python3 validate_env.py
```

---

**最終更新:** 2025年12月27日
