# 🔧 **温度システム対処報告（2025-12-28）**

## **問題1：データベース挿入がハング（デッドロック問題）**

### 原因
`database/queries.py` の `get_all_latest()` メソッドで **ネストされたロック取得** が発生していました。

**修正前の問題コード**：
```python
@staticmethod
def get_all_latest():
    with db_lock:  # ← ロック1を取得
        # ...
        for sensor_id in sensor_ids:
            # ← ロック1を保有したまま、以下を実行
            data = TemperatureQueries.get_latest_reading(sensor_id)
            # get_latest_reading()は内部で with db_lock を実行
            # ❌ デッドロック発生！
```

### デッドロック発生シナリオ
```
時刻13:00:02: GET /api/sensors が実行開始
  └─ db_lockを取得 
    └─ forループで get_latest_reading() を呼び出し
      └─ get_latest_reading() が db_lock を取得しようとする
        └─ ❌ 既にロック保有中のため無限待機...

時刻13:00:07: POST /api/temperature が実行開始
  └─ insert_reading() が db_lock を取得しようとする
    └─ ❌ GET /api/sensors がロック保有中のため無限待機...
    
結果：データ保存できず＆サーバーハング状態
```

### 修正方法
1つのSQLクエリで全センサーの最新データを一括取得（ネストされたロックを回避）：

```python
@staticmethod
def get_all_latest():
    """全センサーの最新データを取得"""
    with db_lock:
        conn = get_connection()
        cursor = conn.cursor()
        
        # ✅ 1つのクエリで全取得（ロック保有期間が短い）
        cursor.execute("""
            SELECT t1.* FROM temperatures t1
            WHERE t1.id = (
                SELECT MAX(id) FROM temperatures t2 
                WHERE t2.sensor_id = t1.sensor_id
            )
            ORDER BY t1.sensor_id
        """)
        rows = cursor.fetchall()
        results = [dict(row) for row in rows]
        conn.close()
        # ← 即座にロック解放（forループなし）
        
        return results
```

### SQL クエリの説明
- `t2.sensor_id = t1.sensor_id`：各センサーでグループ化
- `MAX(id)`：各グループの最新ID（最新データ）を取得
- `t1.id = (...)` のサブクエリ：その最新IDのレコードのみ取得
- **結果**：1回のクエリで全センサーの最新データを効率的に取得

### 修正効果の比較
| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| ロック保有期間 | 長い（全センサー数分ループ） | 短い（1つのクエリのみ） |
| ネストしたロック | あり（❌デッドロック原因） | なし（✅安全） |
| DB接続回数 | 多い（N+1問題） | 1回のみ |
| パフォーマンス | 遅い | 高速 |

**修正対象ファイル**：
- `temperature_server/database/queries.py`

---

## **問題2：ダミーデータが表示される**

### 原因
テストコード実行時にダミーデータが大量にデータベースに挿入されていました。

### 削除したダミーデータ
```
- test：3件
- TEST：テストデータ
- TEST_02：テストデータ
- 異常値（99.9°C）：1件
```

### 対処内容
1. `cleanup_database.py` を修正
   - 不要なインポート（`from database.queries import get_jst_now`）を削除
2. スクリプトを実行

**実行結果**：
```
削除前の総データ数: 997件
削除後の総データ数: 992件
削除されたデータ: 5件

削除内容：
  - TEST: 3件を削除
  - TEST_02: 1件を削除
  - 異常値データ: 1件を削除

残っているセンサー（実データのみ）：
  - ESP32_01 (プロトタイプ01): 929件
  - ESP32_PROT_01 (DS18B20-01): 31件
  - ESP32_PROT_02 (DS18B20-02): 32件
```

**修正対象ファイル**：
- `temperature_server/cleanup_database.py`

---

## **問題3：詳細ログが表示されない**

### 原因
サーバーが再起動されておらず、更新されたコードが読み込まれていませんでした。

### 対処内容
1. ローカルで `app/routes/api.py` を修正
   - リクエスト詳細ログ（IP、ヘッダー、生ボディ）を追加
2. ファイルをリモートサーバーに転送
3. サーバーを再起動

**追加されたログ**：
```python
logger.info("[POST /api/temperature] リクエスト受信")
logger.info(f"IP: {request.remote_addr}")
logger.info(f"リクエストヘッダー: {dict(request.headers)}")
logger.info(f"Content-Type: {request.content_type}")
logger.info(f"Content-Length: {request.content_length}")
logger.info(f"生リクエストボディ: {raw_body}")
logger.info(f"JSONデコード結果: {data}")
logger.info(f"バリデーション - sensor_id: {sensor_id}, temperature: {temperature}")
logger.info(f"✅ データ保存成功 - Device: {sensor_id}, Name: {sensor_name}, Location: {location}, Temp: {temperature}°C")
```

**修正対象ファイル**：
- `temperature_server/app/routes/api.py`

---

## **修正後の正常動作確認**

✅ **全て正常に動作中**

ログ出力例：
```
2025-12-28 13:00:33 - app.routes.api - INFO - [POST /api/temperature] リクエスト受信
2025-12-28 13:00:33 - app.routes.api - INFO - IP: 192.168.4.61
2025-12-28 13:00:33 - app.routes.api - INFO - リクエストヘッダー: {'Host': '192.168.4.1:5000', 'User-Agent': 'ESP32HTTPClient', 'Connection': 'keep-alive', 'Accept-Encoding': 'identity;q=1,chunked;q=0.1,*;q=0', 'Content-Type': 'application/json', 'Content-Length': '97'}
2025-12-28 13:00:33 - app.routes.api - INFO - Content-Type: application/json
2025-12-28 13:00:33 - app.routes.api - INFO - Content-Length: 97
2025-12-28 13:00:33 - app.routes.api - INFO - 生リクエストボディ: {"device_id":"ESP32_PROT_01","name":"DS18B20-01","location":"設定なし","temperature":22.5625}
2025-12-28 13:00:33 - app.routes.api - INFO - JSONデコード結果: {'device_id': 'ESP32_PROT_01', 'name': 'DS18B20-01', 'location': '設定なし', 'temperature': 22.5625}
2025-12-28 13:00:33 - app.routes.api - INFO - バリデーション - sensor_id: ESP32_PROT_01, temperature: 22.5625
2025-12-28 13:00:33 - app.routes.api - INFO - ✅ データ保存成功 - Device: ESP32_PROT_01, Name: DS18B20-01, Location: 設定なし, Temp: 22.5625°C
2025-12-28 13:00:33 - app.routes.api - INFO - ============================================================
```

**ダッシュボード表示確認**：
- ✅ 3つのセンサーのみ表示（ダミーデータなし）
- ✅ リアルタイムデータ更新動作確認
- ✅ グラフ表示正常

---

## **修正ファイル一覧（GitHub/リモートサーバーへ転送済み）**

1. **`temperature_server/app/routes/api.py`**
   - リクエスト詳細ログの追加
   - DB挿入エラーハンドリングの強化

2. **`temperature_server/database/queries.py`**
   - `get_all_latest()` メソッドの修正（デッドロック解決）
   - 1つのSQLクエリで全センサーの最新データを取得

3. **`temperature_server/cleanup_database.py`**
   - 不要なインポート削除
   - ダミーデータ削除スクリプト

---

## **今後の推奨事項**

### テスト環境の改善
- テスト実行時は、本番データベースと分離する
- テスト用の `test_temperature.db` を使用する設定を検討

### ロギングの推奨設定
- API呼び出しは現在の詳細ログレベルで問題なし
- 本番環境では DEBUG レベルのログを INFO に変更を検討

### パフォーマンス最適化
- センサー数が増加した場合、クエリのインデックス活用を確認
- キャッシング機構の導入を検討（Redis など）

---

**対処完了日時：2025-12-28 13:04 JST**
