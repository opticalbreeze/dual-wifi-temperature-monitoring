<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .nav a { padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: 0.3s; }
        .nav a.active { background: #764ba2; }
        .nav a:hover { opacity: 0.9; }
        h1 { text-align: center; color: #333; margin-bottom: 25px; }
        .tab-buttons { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 16px; border: 2px solid #ddd; background: white; color: #333; cursor: pointer; border-radius: 6px; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .tab-btn:hover { border-color: #667eea; }
        .panel { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none; }
        .panel.active { display: block; }
        .panel h3 { color: #667eea; margin-bottom: 15px; font-size: 1.2em; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        button { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.95em; }
        .btn-primary { background: #4caf50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-info { background: #2196F3; color: white; }
        .btn-info:hover { background: #0b7dda; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .status-box { background: #f9f9f9; padding: 12px 15px; border-left: 4px solid #4caf50; margin: 10px 0; border-radius: 4px; }
        .status-box.warn { border-left-color: #ff9800; }
        .status-box.error { border-left-color: #f44336; }
        .status-value { font-size: 1.3em; font-weight: bold; color: #667eea; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .sensor-card { background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #eee; margin: 8px 0; }
        .sensor-card input { width: 100%; padding: 6px; margin: 6px 0; border: 1px solid #ddd; border-radius: 4px; }
        .log-viewer { background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto; }
        .log-error { color: #f44336; }
        .log-warn { color: #ff9800; }
        .log-info { color: #4caf50; }
        .input-group { margin-bottom: 15px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: 600; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; }
        .modal-content h2 { margin-bottom: 20px; color: #667eea; }
        .chart { width: 100%; height: 200px; background: #f0f0f0; border-radius: 6px; margin-top: 10px; display: flex; align-items: flex-end; gap: 2px; padding: 10px; }
        .chart-bar { flex: 1; background: #667eea; border-radius: 3px 3px 0 0; min-height: 20px; }
        .success-msg { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #4caf50; }
        .error-msg { background: #ffebee; color: #c62828; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="/stream">ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°</a>
            <a href="/management" class="active">ç®¡ç†ç”»é¢</a>
        </div>

        <h1>ğŸ› ï¸ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</h1>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('status')">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
            <button class="tab-btn" onclick="switchTab('sensors')">ğŸ“¡ ã‚»ãƒ³ã‚µãƒ¼ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('performance')">âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</button>
            <button class="tab-btn" onclick="switchTab('logs')">ğŸ“‹ ãƒ­ã‚°</button>
            <button class="tab-btn" onclick="switchTab('data')">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
            <button class="tab-btn" onclick="switchTab('test')">ğŸ§ª ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– -->
        <div id="status" class="panel active">
            <h3>ğŸ” ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div id="status-content">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ã‚»ãƒ³ã‚µãƒ¼ç®¡ç†ã‚¿ãƒ– -->
        <div id="sensors" class="panel">
            <h3>ğŸ“¡ æ¥ç¶šã‚»ãƒ³ã‚µãƒ¼</h3>
            <div class="button-group">
                <button class="btn-primary" onclick="refreshSensors()">ğŸ”„ æ›´æ–°</button>
                <button class="btn-info" onclick="showAddSensorModal()">â• ã‚»ãƒ³ã‚µãƒ¼è¿½åŠ </button>
            </div>
            <div id="sensors-content">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¿ãƒ– -->
        <div id="performance" class="panel">
            <h3>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</h3>
            <div class="grid-2">
                <div>
                    <h4>CPUä½¿ç”¨ç‡</h4>
                    <div class="chart" id="cpu-chart"></div>
                </div>
                <div>
                    <h4>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</h4>
                    <div class="chart" id="memory-chart"></div>
                </div>
            </div>
            <div class="status-box">
                <strong>ãƒ‡ã‚£ã‚¹ã‚¯:</strong> <span id="disk-usage" class="status-value">-</span>
            </div>
            <div class="status-box">
                <strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶:</strong> <span id="network-ping" class="status-value">-</span>
            </div>
            <button class="btn-info" onclick="measurePerformance()">æ¸¬å®šé–‹å§‹</button>
        </div>

        <!-- ãƒ­ã‚°ã‚¿ãƒ– -->
        <div id="logs" class="panel">
            <h3>ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h3>
            <div class="button-group">
                <button class="btn-info" onclick="loadLogs()">ğŸ”„ æ›´æ–°</button>
                <select id="log-filter" onchange="filterLogs(this.value)" style="width: auto; padding: 8px;">
                    <option value="">å…¨ã¦</option>
                    <option value="error">ã‚¨ãƒ©ãƒ¼</option>
                    <option value="warn">è­¦å‘Š</option>
                    <option value="info">æƒ…å ±</option>
                </select>
                <button class="btn-primary" onclick="exportLogs()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
            <div class="log-viewer" id="log-content">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¿ãƒ– -->
        <div id="data" class="panel">
            <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div class="input-group">
                <label>å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆæŒ‡å®šæ—¥æ•°ä»¥å‰ï¼‰</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="days-old" min="1" max="365" value="30" style="flex: 1;" placeholder="æ—¥æ•°">
                    <button class="btn-danger" onclick="deleteOldData()">å‰Šé™¤</button>
                </div>
            </div>
            <div id="data-message"></div>
            <div class="button-group">
                <button class="btn-primary" onclick="backupDatabase()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
                <button class="btn-info" onclick="exportCSV()">ğŸ“Š CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼ã‚¿ãƒ– -->
        <div id="test" class="panel">
            <h3>ğŸ§ª ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼ç®¡ç†</h3>
            <div class="button-group">
                <button class="btn-primary" onclick="showAddTestSensorModal()">â• ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼è¿½åŠ </button>
                <button class="btn-danger" onclick="deleteAllTestSensors()">ğŸ—‘ï¸ å…¨ãƒ†ã‚¹ãƒˆå‰Šé™¤</button>
            </div>
            <div id="test-sensors-content">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- ã‚»ãƒ³ã‚µãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="add-sensor-modal" class="modal">
        <div class="modal-content">
            <h2>ã‚»ãƒ³ã‚µãƒ¼ã‚’è¿½åŠ </h2>
            <div class="input-group">
                <label>ã‚»ãƒ³ã‚µãƒ¼ID</label>
                <input type="text" id="sensor-id" placeholder="ä¾‹: ESP32_NEW_01">
            </div>
            <div class="input-group">
                <label>ã‚»ãƒ³ã‚µãƒ¼å</label>
                <input type="text" id="sensor-name" placeholder="ä¾‹: å±…é–“">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="addSensor()">è¿½åŠ </button>
                <button class="btn-info" onclick="closeModal('add-sensor-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="add-test-sensor-modal" class="modal">
        <div class="modal-content">
            <h2>ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼ã‚’è¿½åŠ </h2>
            <div class="input-group">
                <label>ã‚»ãƒ³ã‚µãƒ¼å</label>
                <input type="text" id="test-sensor-name" placeholder="ä¾‹: TEST_01">
            </div>
            <div class="input-group">
                <label>åˆæœŸæ¸©åº¦ (Â°C)</label>
                <input type="number" id="test-sensor-temp" min="-50" max="100" value="25" step="0.1">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="addTestSensor()">è¿½åŠ </button>
                <button class="btn-info" onclick="closeModal('add-test-sensor-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'status') loadStatus();
            if (tabName === 'sensors') refreshSensors();
            if (tabName === 'logs') loadLogs();
            if (tabName === 'test') loadTestSensors();
        }

        async function loadStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                const html = `
                    <div class="status-box">
                        <strong>æ¥ç¶šã‚»ãƒ³ã‚µãƒ¼:</strong> <span class="status-value">${data.connected_sensors}</span> å°
                    </div>
                    <div class="status-box">
                        <strong>ãƒ¡ãƒ¢ãƒª:</strong> <span class="status-value">${data.memory_percent}%</span>
                    </div>
                    <div class="status-box">
                        <strong>ãƒ‡ã‚£ã‚¹ã‚¯:</strong> <span class="status-value">${data.disk_percent}%</span>
                    </div>
                    <div class="status-box ${data.uptime_seconds > 3600 ? '' : 'warn'}">
                        <strong>ç¨¼åƒæ™‚é–“:</strong> <span class="status-value">${(data.uptime_seconds / 3600).toFixed(1)}æ™‚é–“</span>
                    </div>
                `;
                document.getElementById('status-content').innerHTML = html;
            } catch (e) {
                document.getElementById('status-content').innerHTML = '<div class="error-msg">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—: ' + e.message + '</div>';
            }
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHtml(text) {
            if (text == null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        async function refreshSensors() {
            try {
                const res = await fetch('/api/sensors');
                const data = await res.json();
                const container = document.getElementById('sensors-content');
                
                if (!data.sensors || data.sensors.length === 0) {
                    container.innerHTML = '<div class="error-msg">ã‚»ãƒ³ã‚µãƒ¼ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }
                
                let html = '';
                data.sensors.forEach(sensor => {
                    const sensorId = escapeHtml(sensor.sensor_id);
                    const sensorName = escapeHtml(sensor.sensor_name || sensor.sensor_id);
                    const temp = sensor.temperature ? sensor.temperature.toFixed(1) : '-';
                    const timestamp = sensor.timestamp ? new Date(sensor.timestamp).toLocaleString('ja-JP') : '-';
                    
                    html += `
                        <div class="sensor-card" data-sensor-id="${sensorId}">
                            <strong>${sensorName}</strong>
                            <input type="text" placeholder="ã‚»ãƒ³ã‚µãƒ¼å" value="${escapeHtml(sensor.sensor_name || '')}" onchange="updateSensorName('${sensorId}', this.value)">
                            <div><small>ID: ${sensorId} | æ¸©åº¦: ${temp}Â°C | æ›´æ–°: ${timestamp}</small></div>
                            <button class="btn-danger btn-small delete-sensor-btn" data-sensor-id="${sensorId}">å‰Šé™¤</button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                container.querySelectorAll('.delete-sensor-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const sensorId = this.getAttribute('data-sensor-id');
                        if (sensorId) {
                            deleteSensor(sensorId);
                        }
                    });
                });
            } catch (e) {
                document.getElementById('sensors-content').innerHTML = '<div class="error-msg">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(e.message) + '</div>';
            }
        }

        async function loadLogs() {
            try {
                const res = await fetch('/api/logs?limit=50');
                const data = await res.json();
                let html = '';
                data.logs.forEach(log => {
                    const className = log.level === 'ERROR' ? 'log-error' : log.level === 'WARN' ? 'log-warn' : 'log-info';
                    html += `<div class="${className}">[${log.level}] ${new Date(log.timestamp).toLocaleTimeString()} - ${log.message}</div>`;
                });
                document.getElementById('log-content').innerHTML = html || 'ãƒ­ã‚°ãªã—';
            } catch (e) {
                document.getElementById('log-content').innerHTML = `<div class="log-error">ãƒ­ã‚°èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}</div>`;
            }
        }

        async function deleteOldData() {
            const days = document.getElementById('days-old').value;
            if (!confirm(`${days}æ—¥ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const res = await fetch('/api/delete-old-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days_old: parseInt(days) })
                });
                const data = await res.json();
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯
                if (res.ok && data.status === 'success') {
                    const deletedCount = data.deleted_count || 0;
                    const msg = `<div class="success-msg">âœ“ ${deletedCount}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</div>`;
                    document.getElementById('data-message').innerHTML = msg;
                } else {
                    const errorMsg = data.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    const msg = `<div class="error-msg">âœ— ã‚¨ãƒ©ãƒ¼: ${errorMsg}</div>`;
                    document.getElementById('data-message').innerHTML = msg;
                }
            } catch (e) {
                const msg = `<div class="error-msg">âœ— ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
                document.getElementById('data-message').innerHTML = msg;
            }
        }

        async function loadTestSensors() {
            try {
                const res = await fetch('/api/sensors');
                const data = await res.json();
                const testSensors = data.sensors.filter(s => s.sensor_id.includes('TEST'));
                const container = document.getElementById('test-sensors-content');
                
                if (!testSensors || testSensors.length === 0) {
                    container.innerHTML = '<div class="error-msg">ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼ãªã—</div>';
                    return;
                }
                
                let html = '';
                testSensors.forEach(sensor => {
                    const sensorId = escapeHtml(sensor.sensor_id);
                    const sensorName = escapeHtml(sensor.sensor_name || sensor.sensor_id);
                    const temp = sensor.temperature ? sensor.temperature.toFixed(1) : '-';
                    
                    html += `
                        <div class="sensor-card" data-sensor-id="${sensorId}">
                            <strong>${sensorName}</strong>
                            <div>${temp}Â°C</div>
                            <button class="btn-danger btn-small delete-test-sensor-btn" data-sensor-id="${sensorId}">å‰Šé™¤</button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                container.querySelectorAll('.delete-test-sensor-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const sensorId = this.getAttribute('data-sensor-id');
                        if (sensorId) {
                            deleteTestSensor(sensorId);
                        }
                    });
                });
            } catch (e) {
                document.getElementById('test-sensors-content').innerHTML = '<div class="error-msg">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(e.message) + '</div>';
            }
        }

        async function deleteAllTestSensors() {
            if (!confirm('å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const res = await fetch('/api/delete-test-sensors', { method: 'POST' });
                const data = await res.json();
                alert(data.message || 'å‰Šé™¤å®Œäº†');
                loadTestSensors();
            } catch (e) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        function showAddSensorModal() {
            document.getElementById('add-sensor-modal').classList.add('show');
        }

        function showAddTestSensorModal() {
            document.getElementById('add-test-sensor-modal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function measurePerformance() {
            const start = performance.now();
            await fetch('/api/status');
            const ping = ((performance.now() - start) / 2).toFixed(0);
            document.getElementById('network-ping').textContent = ping + 'ms';
        }

        async function deleteSensor(id) {
            if (!id) {
                console.error('deleteSensor: sensor_id is empty');
                alert('âœ— ã‚¨ãƒ©ãƒ¼: ã‚»ãƒ³ã‚µãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('deleteSensor called with id:', id);
            
            // ã¾ãšãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§APIãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
            try {
                const testRes = await fetch('/api/test-delete');
                const testText = await testRes.text();
                console.log('Test endpoint response:', testText.substring(0, 200));
                if (!testRes.ok || !testText.includes('success')) {
                    console.warn('Test endpoint failed, but continuing...');
                }
            } catch (testError) {
                console.warn('Test endpoint check failed:', testError);
            }
            
            if (!confirm(`ã‚»ãƒ³ã‚µãƒ¼ ${id} ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const url = `/api/sensors/${encodeURIComponent(id)}`;
                console.log('DELETE request to:', url);
                console.log('Full URL:', window.location.origin + url);
                
                const res = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', res.status);
                console.log('Response statusText:', res.statusText);
                console.log('Response Content-Type:', res.headers.get('Content-Type'));
                console.log('Response URL:', res.url);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—
                const responseText = await res.text();
                console.log('Response text length:', responseText.length);
                console.log('Response text (first 500 chars):', responseText.substring(0, 500));
                
                // HTMLãŒè¿”ã£ã¦ãã¦ã„ã‚‹å ´åˆã®å‡¦ç†
                if (responseText.trim().startsWith('<!') || responseText.includes('<!doctype')) {
                    console.error('HTML response received instead of JSON');
                    console.error('Full HTML response:', responseText);
                    alert(`âœ— ã‚¨ãƒ©ãƒ¼: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n\nã‚µãƒ¼ãƒãƒ¼ãŒHTMLãƒšãƒ¼ã‚¸ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚\n\nç¢ºèªäº‹é …:\n1. ã‚µãƒ¼ãƒãƒ¼ãŒå†èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã‹\n2. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹\n\nè©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                // Content-Typeã‚’ç¢ºèª
                const contentType = res.headers.get('Content-Type') || '';
                if (!contentType.includes('application/json')) {
                    console.error('Non-JSON response. Content-Type:', contentType);
                    console.error('Full response:', responseText);
                    alert(`âœ— ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONä»¥å¤–ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status}\nContent-Type: ${contentType}\nURL: ${res.url}\n\nè©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                // JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text:', responseText);
                    alert(`âœ— ã‚¨ãƒ©ãƒ¼: JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status}\n\nè©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                console.log('Response data:', data);
                
                if (res.ok && data.status === 'success') {
                    alert(`âœ“ ${data.deleted_count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    refreshSensors();
                } else {
                    alert(`âœ— ã‚¨ãƒ©ãƒ¼: ${data.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            } catch (e) {
                console.error('deleteSensor error:', e);
                console.error('Error stack:', e.stack);
                alert(`âœ— ã‚¨ãƒ©ãƒ¼: ${e.message}\n\nè©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }
        
        async function deleteTestSensor(id) {
            if (!id) {
                console.error('deleteTestSensor: sensor_id is empty');
                alert('âœ— ã‚¨ãƒ©ãƒ¼: ã‚»ãƒ³ã‚µãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('deleteTestSensor called with id:', id);
            
            if (!confirm(`ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼ ${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const url = `/api/sensors/${encodeURIComponent(id)}`;
                console.log('DELETE request to:', url);
                
                const res = await fetch(url, {
                    method: 'DELETE'
                });
                
                console.log('Response status:', res.status);
                
                const data = await res.json();
                console.log('Response data:', data);
                
                if (res.ok && data.status === 'success') {
                    alert(`âœ“ ${data.deleted_count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    loadTestSensors();
                } else {
                    alert(`âœ— ã‚¨ãƒ©ãƒ¼: ${data.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            } catch (e) {
                console.error('deleteTestSensor error:', e);
                alert(`âœ— ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }
        }
        
        function exportCSV() {
            const hours = prompt('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æœŸé–“ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆæ™‚é–“ï¼‰\nä¾‹: 720 (1ãƒ¶æœˆ)', '720');
            if (!hours || isNaN(hours)) {
                return;
            }
            
            const sensorId = prompt('ç‰¹å®šã®ã‚»ãƒ³ã‚µãƒ¼ã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å ´åˆã¯ã‚»ãƒ³ã‚µãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nï¼ˆç©ºæ¬„ã§å…¨ã‚»ãƒ³ã‚µãƒ¼ï¼‰', '');
            
            let url = `/api/export/csv?hours=${hours}`;
            if (sensorId) {
                url += `&sensor_id=${encodeURIComponent(sensorId)}`;
            }
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportLogs() {
            const limit = prompt('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ­ã‚°ä»¶æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„', '1000');
            if (!limit || isNaN(limit)) {
                return;
            }
            
            const level = prompt('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„\nï¼ˆERROR, WARN, INFO ã¾ãŸã¯ç©ºæ¬„ã§å…¨ã¦ï¼‰', '');
            
            let url = `/api/export/logs?limit=${limit}`;
            if (level) {
                url += `&level=${encodeURIComponent(level)}`;
            }
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function backupDatabase() {
            if (!confirm('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const res = await fetch('/api/backup');
                
                if (res.ok) {
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
                    const contentDisposition = res.headers.get('Content-Disposition');
                    let filename = 'temperature_backup.db';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match) {
                            filename = match[1];
                        }
                    }
                    
                    // Blobã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    alert('âœ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ');
                } else {
                    const data = await res.json();
                    alert(`âœ— ã‚¨ãƒ©ãƒ¼: ${data.message || 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            } catch (e) {
                alert(`âœ— ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            }
        }
        
        function updateSensorName(id, name) { console.log('Update:', id, name); }
        function addSensor() { alert('ã‚»ãƒ³ã‚µãƒ¼è¿½åŠ æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™'); closeModal('add-sensor-modal'); }
        function addTestSensor() { alert('ãƒ†ã‚¹ãƒˆã‚»ãƒ³ã‚µãƒ¼è¿½åŠ æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™'); closeModal('add-test-sensor-modal'); }
        function filterLogs(level) {
            // ãƒ­ã‚°ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            loadLogs().then(() => {
                const logs = document.querySelectorAll('#log-content > div');
                logs.forEach(log => {
                    if (!level) {
                        log.style.display = '';
                    } else {
                        const levelClass = level === 'error' ? 'log-error' : 
                                         level === 'warn' ? 'log-warn' : 'log-info';
                        log.style.display = log.classList.contains(levelClass) ? '' : 'none';
                    }
                });
            });
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        window.onload = () => loadStatus();
    </script>
</body>
</html>
