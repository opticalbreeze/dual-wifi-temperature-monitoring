# ã‚³ãƒ¼ãƒ‰æ”¹å–„ã‚¬ã‚¤ãƒ‰ - ã‚¨ãƒ©ãƒ¼è¿½è·¡ã¨ä¿å®ˆæ€§ã®å‘ä¸Š

## ğŸ“‹ æ¦‚è¦

ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãŒå¤§ãããªã‚Šã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®åŸå› ç‰¹å®šãŒå›°é›£ã«ãªã£ã¦ã„ã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®æ”¹å–„æ¡ˆã§ã™ã€‚

## ğŸ¯ å®Ÿè£…ã—ãŸæ”¹å–„å†…å®¹

### 1. çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `utils/exceptions.py`

- ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©
- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã€è©³ç´°æƒ…å ±ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’çµ±ä¸€
- ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æ§‹é€ åŒ–ã—ã¦è¿”å´

**ä¸»ãªä¾‹å¤–ã‚¯ãƒ©ã‚¹**:
- `BaseApplicationException`: åŸºæœ¬ä¾‹å¤–
- `ValidationException`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆ400ï¼‰
- `DatabaseException`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ï¼ˆ500ï¼‰
- `SensorException`: ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ã‚¨ãƒ©ãƒ¼ï¼ˆ400ï¼‰
- `WiFiException`: WiFié–¢é€£ã‚¨ãƒ©ãƒ¼ï¼ˆ500ï¼‰

**ä½¿ç”¨ä¾‹**:
```python
from utils.exceptions import ValidationException

if not sensor_id:
    raise ValidationException(
        message="ã‚»ãƒ³ã‚µãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“",
        field='sensor_id'
    )
```

### 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `utils/request_tracing.py`

- å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä¸€æ„ã®IDã‚’ä»˜ä¸
- ãƒ­ã‚°ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’è¨˜éŒ²ã—ã¦è¿½è·¡å¯èƒ½ã«
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã§ãƒ­ã‚°ã‚’æ¤œç´¢å¯èƒ½

**ä½¿ç”¨ä¾‹**:
```python
from utils.request_tracing import trace_request, log_with_request_id

@api_bp.route('/api/temperature', methods=['POST'])
@trace_request
def receive_temperature():
    log_with_request_id("å‡¦ç†é–‹å§‹", level='info')
    # å‡¦ç†...
```

**ãƒ­ã‚°å‡ºåŠ›ä¾‹**:
```
[abc12345] POST /api/temperature from 192.168.4.100
[abc12345] å‡¦ç†é–‹å§‹
[abc12345] Request completed successfully
```

### 3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢

**ãƒ•ã‚¡ã‚¤ãƒ«**: `utils/validators.py`

- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’ç‹¬ç«‹ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åˆ†é›¢
- å†åˆ©ç”¨å¯èƒ½ã§ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„æ§‹é€ 
- çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

**ä¸»ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°**:
- `validate_sensor_id()`: ã‚»ãƒ³ã‚µãƒ¼IDã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `validate_temperature()`: æ¸©åº¦å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `validate_humidity()`: æ¹¿åº¦å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `validate_temperature_request()`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¨ä½“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `validate_hours()`: æ™‚é–“ç¯„å›²ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `validate_sensor_ids()`: ã‚»ãƒ³ã‚µãƒ¼IDãƒªã‚¹ãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**ä½¿ç”¨ä¾‹**:
```python
from utils.validators import validate_temperature_request

is_valid, error_msg, validated_data = validate_temperature_request(data)
if not is_valid:
    raise ValidationException(message=error_msg)
```

### 4. çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

**ãƒ•ã‚¡ã‚¤ãƒ«**: `utils/error_handler.py`

- `@handle_errors` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§ã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•å‡¦ç†
- ä¾‹å¤–ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸé©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”å´
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã‚‹

**ä½¿ç”¨ä¾‹**:
```python
from utils.error_handler import handle_errors

@api_bp.route('/api/temperature', methods=['POST'])
@handle_errors
def receive_temperature():
    # å‡¦ç†...
    # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€è‡ªå‹•çš„ã«é©åˆ‡ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "status": "error",
  "error_code": "VALIDATION_ERROR",
  "message": "ã‚»ãƒ³ã‚µãƒ¼IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“",
  "details": {
    "field": "sensor_id"
  },
  "request_id": "abc12345"
}
```

### 5. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

**ãƒ•ã‚¡ã‚¤ãƒ«**: `utils/health_check.py`

- ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’ç›£è¦–
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãƒ‡ã‚£ã‚¹ã‚¯ã€ãƒ¡ãƒ¢ãƒªã€ã‚»ãƒ³ã‚µãƒ¼ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
- `/api/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç¢ºèªå¯èƒ½

**ãƒã‚§ãƒƒã‚¯é …ç›®**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
- ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶šçŠ¶æ…‹

**ä½¿ç”¨ä¾‹**:
```python
from utils.health_check import HealthChecker

health_status = HealthChecker.check_all()
# {
#   "status": "healthy",
#   "timestamp": "2025-01-01T12:00:00",
#   "checks": {
#     "database": {...},
#     "disk": {...},
#     "memory": {...},
#     "sensors": {...}
#   }
# }
```

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ç§»è¡Œ

1. **æ–°ã—ã„APIãƒ«ãƒ¼ãƒˆã‚’ä½¿ç”¨**ï¼ˆæ¨å¥¨ï¼‰:
   ```python
   # app/routes/api_improved.py ã‚’å‚ç…§
   # æ—¢å­˜ã® api.py ã‚’æ®µéšçš„ã«ç½®ãæ›ãˆ
   ```

2. **æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«æ®µéšçš„ã«é©ç”¨**:
   ```python
   # 1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
   from utils.error_handler import handle_errors
   from utils.request_tracing import trace_request
   from utils.validators import validate_temperature_request
   from utils.exceptions import ValidationException
   
   # 2. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ 
   @api_bp.route('/api/temperature', methods=['POST'])
   @trace_request
   @handle_errors
   def receive_temperature():
       # 3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç½®ãæ›ãˆ
       is_valid, error_msg, validated_data = validate_temperature_request(data)
       if not is_valid:
           raise ValidationException(message=error_msg)
       
       # 4. æ—¢å­˜ã®å‡¦ç†...
   ```

### ã‚¨ãƒ©ãƒ¼è¿½è·¡ã®æ–¹æ³•

1. **ãƒ­ã‚°ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’æ¤œç´¢**:
   ```bash
   grep "abc12345" logs/app.routes.api.log
   ```

2. **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§çŠ¶æ…‹ç¢ºèª**:
   ```bash
   curl http://192.168.4.1:5000/api/health
   ```

3. **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’å–å¾—**:
   ```json
   {
     "status": "error",
     "error_code": "DATABASE_ERROR",
     "message": "...",
     "request_id": "abc12345"
   }
   ```

## ğŸ” ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®èª¿æŸ»æ‰‹é †

1. **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’å–å¾—**
2. **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’æ¤œç´¢**:
   ```bash
   grep "abc12345" logs/*.log
   ```
3. **ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§åˆ†é¡**:
   - `VALIDATION_ERROR`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ â†’ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
   - `DATABASE_ERROR`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ â†’ DBæ¥ç¶šã¨ã‚¯ã‚¨ãƒªã‚’ç¢ºèª
   - `SENSOR_ERROR`: ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ã‚¨ãƒ©ãƒ¼ â†’ ã‚»ãƒ³ã‚µãƒ¼IDã¨ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
4. **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèª**:
   ```bash
   curl http://192.168.4.1:5000/api/health
   ```

## ğŸ“Š æ”¹å–„åŠ¹æœ

### Beforeï¼ˆæ”¹å–„å‰ï¼‰
- âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„
- âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€ã®ç‰¹å®šãŒå›°é›£
- âŒ ãƒ­ã‚°ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’è¿½è·¡ã—ã«ãã„
- âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†æ•£ã—ã¦ã„ã‚‹

### Afterï¼ˆæ”¹å–„å¾Œï¼‰
- âœ… çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã§ãƒ­ã‚°ã‚’è¿½è·¡å¯èƒ½
- âœ… ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§åˆ†é¡ãƒ»æ¤œç´¢å¯èƒ½
- âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ãŒé›†ç´„ã•ã‚Œã¦ã„ã‚‹
- âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç›£è¦–å¯èƒ½

## ğŸš€ ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

1. **å‹ãƒ’ãƒ³ãƒˆã®è¿½åŠ **: å‹å®‰å…¨æ€§ã®å‘ä¸Š
2. **ãƒ†ã‚¹ãƒˆã®å……å®Ÿ**: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆè¿½åŠ 
3. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†**: Prometheusç­‰ã§ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
4. **ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½**: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è‡ªå‹•é€šçŸ¥
5. **ã‚¨ãƒ©ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: WebUIã§ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `utils/exceptions.py`: ä¾‹å¤–ã‚¯ãƒ©ã‚¹å®šç¾©
- `utils/validators.py`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
- `utils/error_handler.py`: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿
- `utils/request_tracing.py`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°
- `utils/health_check.py`: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
- `app/routes/api_improved.py`: æ”¹å–„ã•ã‚ŒãŸAPIãƒ«ãƒ¼ãƒˆä¾‹

