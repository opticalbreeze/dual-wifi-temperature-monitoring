# データ間引き（ダウンサンプリング）について

## 概要

グラフ表示のパフォーマンス向上のため、ブラウザ側でデータの間引き（ダウンサンプリング）を実施しています。

## 実装場所

- **ファイル**: `templates/dashboard.html`
- **関数**: `downsampleData(dataPoints, maxPoints)`
- **設定**: `MAX_CHART_POINTS = 500`（最大500ポイント）

## 間引きの仕組み

### 1. 基本動作

データポイント数が500を超える場合、以下の優先順位で間引きを実施：

1. **最初と最後のポイント**: 必ず保持
2. **最大値・最小値**: データ全体の最大温度・最小温度のポイントを保持
3. **急激な変化**: 前後のポイントとの変化が0.5°C以上の箇所を保持
4. **均等間引き**: 残りのポイントを均等に間引き

### 2. 間引きの例

**元データ（24時間分、30秒間隔）:**
- データポイント数: 約2,880ポイント
- 通信量: 約100KB

**間引き後:**
- データポイント数: 最大500ポイント
- 通信量: 約20KB
- **削減率: 約80%**

## 注意事項

⚠️ **間引きを実施すると、一部の細かい温度変化を見逃す可能性があります。**

- 最大値・最小値は保持されますが、その間の細かい変動は失われる可能性があります
- 急激な変化（0.5°C以上）は検出されますが、それ以下の変化は間引かれる可能性があります

## 間引きを無効化する方法

間引きを無効化したい場合は、以下の設定を変更してください：

### 方法1: 最大ポイント数を増やす

```javascript
// templates/dashboard.html
const MAX_CHART_POINTS = 10000; // 500 → 10000に変更
```

### 方法2: 間引きを完全に無効化

```javascript
// templates/dashboard.html
// downsampleData() の呼び出しをコメントアウト
// const downsampledPoints = downsampleData(dataPoints, MAX_CHART_POINTS);
const downsampledPoints = dataPoints; // 間引きなし
```

### 方法3: サーバー側で全データを返す

サーバー側の間引き機能（`database/queries.py`の`get_range_batch`）を無効化する場合は、`max_points_per_sensor`パラメータを削除または大きな値に設定してください。

## パフォーマンスへの影響

### 間引きあり（500ポイント）
- 通信時間: 約0.5秒
- 描画時間: 約0.1秒
- メモリ使用量: 約2MB

### 間引きなし（2,880ポイント）
- 通信時間: 約2.5秒
- 描画時間: 約1.0秒
- メモリ使用量: 約10MB

## 推奨設定

- **24時間以下**: 間引きなし（データ量が少ないため）
- **24時間以上**: 間引きあり（パフォーマンス向上のため）

## 更新履歴

- 2025-12-29: 最大値・最小値・急激な変化を保持する改善版を実装

