# AI 行動制約ルール

**作成日**: 2025年12月29日  
**目的**: AIが危険な操作を実行することを防止する

---

## 🔴 絶対に実行してはいけないこと

### 1. ネットワーク設定変更スクリプトのリモート実行

**禁止**:
- SSH経由でネットワーク設定を変更するスクリプトを実行する
- `ip addr`, `ip link`, `nmcli` などのコマンドを含むスクリプトをリモート実行する
- `systemctl restart hostapd`, `systemctl restart dnsmasq` をリモート実行する

**理由**: 接続が切断される可能性がある

### 2. 危険なコマンドを含むスクリプトの作成・実行

**禁止**:
- `killall wpa_supplicant` を含むスクリプト
- `systemctl stop wpa_supplicant` を含むスクリプト
- `systemctl stop NetworkManager` を含むスクリプト
- `ip link set <interface> down` （接続中のインターフェース）

**理由**: 複数のインターフェースに影響し、接続が切れる

### 3. チェックリストを無視した実行

**禁止**:
- チェックリストを作成した後、その内容を無視して実行する
- 「後でチェックします」と言って実行する
- 警告を無視して実行する

---

## ✅ 実行前の必須チェック

### ステップ1: スクリプト内容の確認

```bash
# スクリプトに危険なコマンドが含まれていないか確認
grep -E "killall|pkill|systemctl stop" <script>
```

### ステップ2: リモート実行の検出

```bash
# SSH接続中かどうか確認
if [ -n "$SSH_CONNECTION" ]; then
    echo "リモート実行は禁止されています"
    exit 1
fi
```

### ステップ3: 接続経路の確認

```bash
# デフォルトゲートウェイを確認
ip route show default
```

### ステップ4: 影響範囲の確認

```bash
# どのインターフェースが接続に使われているか確認
ip addr show
```

---

## 🛡️ 強制的な防止策

### 1. スクリプトに組み込む安全チェック

すべてのネットワーク設定スクリプトに以下を必須で組み込む：

```bash
#!/bin/bash
# リモート実行の検出（必須）
if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_CLIENT" ]; then
    echo "❌ エラー: このスクリプトはリモート実行できません。"
    echo "現地操作が必要です。"
    exit 1
fi

# 接続経路の確認（必須）
DEFAULT_IF=$(ip route show default 2>/dev/null | awk '{print $5}' | head -1)
if [ "$DEFAULT_IF" = "wlan1" ]; then
    echo "❌ エラー: wlan1が接続に使用されています。"
    exit 1
fi
```

### 2. 危険なコマンドの検出

スクリプト実行前に、危険なコマンドを検出：

```bash
# 危険なコマンドが含まれている場合は実行を阻止
if grep -qE "killall|pkill.*wpa_supplicant" "$SCRIPT"; then
    echo "❌ 危険なコマンドが検出されました。実行を中止します。"
    exit 1
fi
```

### 3. 実行前の自動チェック

`scripts/pre_commit_check.sh` を使用して、スクリプト作成時に自動チェック

---

## 📋 実行前チェックリスト（強制）

以下のチェックを**必ず**実行する：

- [ ] スクリプトに危険なコマンド（`killall`, `systemctl stop`）が含まれていないか確認
- [ ] リモート実行検出機能が組み込まれているか確認
- [ ] 接続経路（wlan0）への影響がないか確認
- [ ] 警告メッセージと確認プロンプトがあるか確認
- [ ] **実際にチェックを実行したか**（チェックリストを見ただけでは不十分）

---

## 🚨 緊急時の対応

もし危険なスクリプトを実行してしまった場合：

1. **即座に実行を停止**
2. **接続状態を確認**
3. **現地での復旧手順を提示**

---

## 💡 重要な原則

**「チェックリストを作成した」≠「チェックを実行した」**

- チェックリストは作成するだけでなく、**実際にチェックを実行する**
- スクリプトに強制的な安全チェックを組み込む
- リモート実行を検出して自動的に阻止する

---

このルールは、AIがチェックリストを無視しても、スクリプト自体が実行を阻止するためのものです。


