# æ¸©åº¦ãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ  - ã‚³ãƒ¼ãƒ‰ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

**ç›£æŸ»æ—¥**: 2025å¹´12æœˆ28æ—¥  
**å¯¾è±¡**: `temperature_server/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª  
**ç›®çš„**: ä¸å…·åˆã€è‚¥å¤§åŒ–ã€é‡è¤‡ã€ä¸è¦ãªé–¢æ•°ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®š

---

## ğŸ”´ é‡å¤§ãªå•é¡Œ

### 1. **`flask_app.py` ã¨ `app/__init__.py` ã®é‡è¤‡**

**å•é¡Œ**: `app/flask_app.py` ãŒ `app/__init__.py` ã® `create_app()` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŒã€ã“ã‚Œè‡ªä½“ãŒé‡è¤‡ã—ãŸã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ãªã£ã¦ã„ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: 
- `temperature_server/app/flask_app.py` (13è¡Œ)
- `temperature_server/app/__init__.py` (85è¡Œ)

**å•é¡Œç‚¹**:
- `flask_app.py` ã¯ `run.py` ãŒæ—¢ã« `app/__init__.py` ã‹ã‚‰ `create_app()` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŸã‚ã€ä¸è¦ãªé‡è¤‡
- 2ã¤ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆãŒå­˜åœ¨ã—ã€æ··ä¹±ã®åŸå› ã¨ãªã‚‹
- `flask_app.py` ã¯ `run.py` ã‚ˆã‚Šã‚‚åŠ£ã£ã¦ã„ã‚‹ï¼ˆè¨­å®šã‚’ `os.getenv()` ã§ç›´æ¥å–å¾—ï¼‰

**æ¨å¥¨å¯¾å¿œ**: `app/flask_app.py` ã‚’å‰Šé™¤

---

### 2. **`api.py` ã® `insert_reading()` è¿”ã‚Šå€¤ã®èª¤ç”¨**

**å•é¡Œ**: `TemperatureQueries.insert_reading()` ã¯è¿”ã‚Šå€¤ãŒ `None` ãªã®ã«ã€`api.py` ã§è¿”ã‚Šå€¤ã‚’å—ã‘å–ã£ã¦ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ã„ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `temperature_server/app/routes/api.py` (57-58è¡Œ)

```python
# ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼ˆèª¤ã‚Šï¼‰
result = TemperatureQueries.insert_reading(sensor_id, temperature, sensor_name, humidity)
logger.info(f"DBæŒ¿å…¥çµæœ: {result}")  # resultã¯å¸¸ã«None
```

**å•é¡Œç‚¹**:
- `queries.py` ã® `insert_reading()` ã¯ `return` æ–‡ãŒãªã„ãŸã‚ã€`None` ã‚’è¿”ã™
- ç„¡æ„å‘³ãªãƒ­ã‚°å‡ºåŠ›ï¼ˆå¸¸ã« `None` ãŒè¨˜éŒ²ã•ã‚Œã‚‹ï¼‰
- å®Ÿéš›ã®æŒ¿å…¥çµæœï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰ã‚’ç¢ºèªã§ããªã„

**æ¨å¥¨å¯¾å¿œ**: 
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: `result` å¤‰æ•°ã¨ãƒ­ã‚°è¡Œã‚’å‰Šé™¤
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: `insert_reading()` ã«è¿”ã‚Šå€¤ï¼ˆæˆåŠŸæ™‚ã¯ `True` ãªã©ï¼‰ã‚’è¿½åŠ 

---

### 3. **`app/__init__.py` ã®å†—é•·ãªãƒ­ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**

**å•é¡Œ**: `log_request()` ã¨ `log_response()` é–¢æ•°å†…ã§ `if request.path.startswith('/api/temperature')` ã§åˆ†å²ã—ã¦ã„ã‚‹ãŒã€å‡¦ç†å†…å®¹ãŒåŒã˜ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `temperature_server/app/__init__.py` (27-42è¡Œ)

```python
@app.before_request
def log_request():
    if request.path.startswith('/api/temperature'):
        logger.debug(f"[REQUEST] {request.method} {request.path} from {request.remote_addr}")
    else:
        logger.debug(f"[REQUEST] {request.method} {request.path} from {request.remote_addr}")  # åŒã˜
```

**å•é¡Œç‚¹**:
- æ¡ä»¶åˆ†å²ãŒæ„å‘³ã‚’ãªã•ãªã„ï¼ˆä¸¡æ–¹ã®åˆ†å²ãŒåŒã˜å‡¦ç†ï¼‰
- ã‚³ãƒ¼ãƒ‰ãŒå†—é•·

**æ¨å¥¨å¯¾å¿œ**: æ¡ä»¶åˆ†å²ã‚’å‰Šé™¤ã—ã€å˜ä¸€ã®ãƒ­ã‚°å‡ºåŠ›ã«çµ±ä¸€

---

### 4. **æœªä½¿ç”¨ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**

**å•é¡Œ**: `app/__init__.py` ã§ `datetime` ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `temperature_server/app/__init__.py` (11è¡Œ)

```python
from datetime import datetime  # ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„
```

**æ¨å¥¨å¯¾å¿œ**: æœªä½¿ç”¨ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤

---

## âš ï¸ ä¸­ç¨‹åº¦ã®å•é¡Œ

### 5. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.bakï¼‰ã®å­˜åœ¨**

**å•é¡Œ**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒ3ã¤æ®‹ã£ã¦ã„ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**:
- `temperature_server/app/routes/api.py.bak`
- `temperature_server/database/queries.py.bak`
- `temperature_server/services/wifi_manager.py.bak`

**æ¨å¥¨å¯¾å¿œ**: Gitã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ï¼ˆGitå±¥æ­´ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰

---

### 6. **ç©ºã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**

**å•é¡Œ**: ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºï¼ˆæœªä½¿ç”¨ï¼‰

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**:
- `temperature_server/app/events/`
- `temperature_server/app/handlers/`
- `temperature_server/app/services/`
- `temperature_server/app/validators/`

**æ¨å¥¨å¯¾å¿œ**: 
- å°†æ¥ä½¿ç”¨äºˆå®šãŒã‚ã‚‹å ´åˆã¯ã€`.gitkeep` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
- ä½¿ç”¨äºˆå®šãŒãªã„å ´åˆã¯å‰Šé™¤

---

### 7. **`api.py` ã®ãƒ­ã‚°ãŒè‚¥å¤§åŒ–**

**å•é¡Œ**: `receive_temperature()` é–¢æ•°ã®ãƒ­ã‚°å‡ºåŠ›ãŒéå‰°ï¼ˆç´„30è¡Œã®ãƒ­ã‚°ã‚³ãƒ¼ãƒ‰ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `temperature_server/app/routes/api.py` (17-81è¡Œ)

**å•é¡Œç‚¹**:
- ãƒ‡ãƒãƒƒã‚°ç”¨ã®è©³ç´°ãƒ­ã‚°ãŒæœ¬ç•ªç’°å¢ƒã§ã‚‚å‡ºåŠ›ã•ã‚Œã‚‹
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‚¥å¤§åŒ–ã™ã‚‹å¯èƒ½æ€§
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«å¤šæ•°ã®ãƒ­ã‚°å‡ºåŠ›ï¼‰

**æ¨å¥¨å¯¾å¿œ**: 
- ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’é©åˆ‡ã«è¨­å®šï¼ˆINFO/DEBUGï¼‰
- æœ¬ç•ªç’°å¢ƒã§ã¯è©³ç´°ãƒ­ã‚°ã‚’å‰Šæ¸›
- é‡è¦ãªæƒ…å ±ã®ã¿ã‚’ãƒ­ã‚°ã«è¨˜éŒ²

**ç¾åœ¨ã®ãƒ­ã‚°å‡ºåŠ›ä¾‹**:
```python
logger.info("[POST /api/temperature] ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡")
logger.info(f"IP: {request.remote_addr}")
logger.info(f"ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼: {dict(request.headers)}")
logger.info(f"Content-Type: {request.content_type}")
logger.info(f"Content-Length: {request.content_length}")
logger.info(f"ç”Ÿãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£: {raw_body}")
logger.info(f"JSONãƒ‡ã‚³ãƒ¼ãƒ‰çµæœ: {data}")
logger.info(f"ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ - sensor_id: {sensor_id}, temperature: {temperature}")
logger.info(f"DBæŒ¿å…¥é–‹å§‹ - sensor_id: {sensor_id}, temp: {temperature}, name: {sensor_name}, humidity: {humidity}")
logger.info(f"DBæŒ¿å…¥çµæœ: {result}")  # ã“ã‚Œã‚‚å•é¡Œï¼ˆå¸¸ã«Noneï¼‰
logger.info(f"âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ - Device: {sensor_id}, Name: {sensor_name}, Location: {location}, Temp: {temperature}Â°C")
logger.info("============================================================")
```

**æ¨å¥¨æ”¹å–„**:
```python
# ãƒ‡ãƒãƒƒã‚°æ™‚ã®ã¿è©³ç´°ãƒ­ã‚°
logger.debug(f"[POST /api/temperature] IP: {request.remote_addr}, Body: {raw_body}")
logger.info(f"Data received - Device: {sensor_id}, Temp: {temperature}Â°C")
# æˆåŠŸæ™‚ã¯ç°¡æ½”ã«
logger.info(f"âœ… Data saved - {sensor_id}: {temperature}Â°C")
```

---

## ğŸ“Š ã‚³ãƒ¼ãƒ‰çµ±è¨ˆ

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ»è¡Œæ•°

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œæ•° | çŠ¶æ…‹ |
|---------|------|------|
| `app/routes/api.py` | 144è¡Œ | âš ï¸ ãƒ­ã‚°è‚¥å¤§åŒ– |
| `app/__init__.py` | 85è¡Œ | âš ï¸ å†—é•·ãªã‚³ãƒ¼ãƒ‰ |
| `database/queries.py` | 160è¡Œ | âœ… è‰¯å¥½ |
| `logger.py` | 82è¡Œ | âœ… è‰¯å¥½ |
| `run.py` | 58è¡Œ | âœ… è‰¯å¥½ |
| `app/flask_app.py` | 13è¡Œ | ğŸ”´ **å‰Šé™¤æ¨å¥¨** |

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«

- `api.py.bak`: æœªç¢ºèªï¼ˆå‰Šé™¤æ¨å¥¨ï¼‰
- `queries.py.bak`: æœªç¢ºèªï¼ˆå‰Šé™¤æ¨å¥¨ï¼‰
- `wifi_manager.py.bak`: æœªç¢ºèªï¼ˆå‰Šé™¤æ¨å¥¨ï¼‰

---

## âœ… æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£æ‰‹é †

### å„ªå…ˆåº¦: é«˜

1. **`app/flask_app.py` ã‚’å‰Šé™¤**
   - `run.py` ãŒå”¯ä¸€ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨

2. **`api.py` ã® `insert_reading()` è¿”ã‚Šå€¤ã®å•é¡Œã‚’ä¿®æ­£**
   - `result` å¤‰æ•°ã¨ãƒ­ã‚°è¡Œã‚’å‰Šé™¤ã€ã¾ãŸã¯ `insert_reading()` ã«è¿”ã‚Šå€¤ã‚’è¿½åŠ 

3. **`app/__init__.py` ã®å†—é•·ãªãƒ­ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä¿®æ­£**
   - æ¡ä»¶åˆ†å²ã‚’å‰Šé™¤

### å„ªå…ˆåº¦: ä¸­

4. **æœªä½¿ç”¨ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤**
   - `app/__init__.py` ã® `datetime` ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

5. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤**
   - `.bak` ãƒ•ã‚¡ã‚¤ãƒ«3ã¤

6. **ç©ºã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ•´ç†**
   - ä½¿ç”¨äºˆå®šãŒã‚ã‚‹å ´åˆã¯ `.gitkeep` ã‚’è¿½åŠ 
   - ä½¿ç”¨äºˆå®šãŒãªã„å ´åˆã¯å‰Šé™¤

### å„ªå…ˆåº¦: ä½

7. **`api.py` ã®ãƒ­ã‚°å‡ºåŠ›ã‚’æœ€é©åŒ–**
   - ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’é©åˆ‡ã«è¨­å®š
   - æœ¬ç•ªç’°å¢ƒã§ã¯è©³ç´°ãƒ­ã‚°ã‚’å‰Šæ¸›

---

## ğŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªè©•ä¾¡

| é …ç›® | è©•ä¾¡ | ã‚³ãƒ¡ãƒ³ãƒˆ |
|------|------|----------|
| **é‡è¤‡ã‚³ãƒ¼ãƒ‰** | âš ï¸ | `flask_app.py` ãŒé‡è¤‡ |
| **ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«** | âš ï¸ | `.bak` ãƒ•ã‚¡ã‚¤ãƒ«ã€ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª |
| **ã‚³ãƒ¼ãƒ‰è‚¥å¤§åŒ–** | âš ï¸ | `api.py` ã®ãƒ­ã‚°ãŒéå‰° |
| **ãƒã‚°** | ğŸ”´ | `insert_reading()` ã®è¿”ã‚Šå€¤èª¤ç”¨ |
| **å†—é•·ãªã‚³ãƒ¼ãƒ‰** | âš ï¸ | `app/__init__.py` ã®ãƒ­ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ |
| **æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰** | âš ï¸ | æœªä½¿ç”¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª |
| **å…¨ä½“çš„ãªå“è³ª** | âš ï¸ | æ”¹å–„ã®ä½™åœ°ã‚ã‚Š |

---

## ğŸ¯ ã¾ã¨ã‚

### é‡å¤§ãªå•é¡Œ
- `flask_app.py` ã®é‡è¤‡ï¼ˆå‰Šé™¤æ¨å¥¨ï¼‰
- `insert_reading()` ã®è¿”ã‚Šå€¤èª¤ç”¨ï¼ˆãƒã‚°ï¼‰
- å†—é•·ãªãƒ­ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¨å¥¨ï¼‰

### æ”¹å–„ã®ä½™åœ°
- ãƒ­ã‚°å‡ºåŠ›ã®æœ€é©åŒ–
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
- ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ•´ç†

### è‰¯ã„ç‚¹
- `database/queries.py` ã¯é©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- `logger.py` ã¯é©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- `run.py` ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§é©åˆ‡

---

## ğŸ”´ è¿½åŠ ã®å•é¡Œ: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‚ç…§ã‚¨ãƒ©ãƒ¼

### 8. **å­˜åœ¨ã—ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»é–¢æ•°ã®å‚ç…§**

**å•é¡Œ**: `tests/test_api_validation.py` ãŒå­˜åœ¨ã—ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«**: `temperature_server/tests/test_api_validation.py` (13-27è¡Œ)

**å•é¡Œç‚¹**:
- `app.exceptions` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ãªã„
- `api.py` ã« `validate_temperature_request`, `validate_hours_param` ãªã©ã®é–¢æ•°ãŒå­˜åœ¨ã—ãªã„
- `TEMPERATURE_MIN`, `TEMPERATURE_MAX`, `HOURS_MIN`, `HOURS_MAX` ãªã©ã®å®šæ•°ãŒå­˜åœ¨ã—ãªã„

**æ¨å¥¨å¯¾å¿œ**: 
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã€ã¾ãŸã¯
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
